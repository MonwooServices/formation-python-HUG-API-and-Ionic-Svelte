<html>

<body>
  <div class="results"></div>
  <!-- TEST OK -->
  <!-- TP -->
  <SCRIPT>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const backendIp = urlParams.get("backendIp") || "192.168.1.100";
    const backendPort = urlParams.get("backendPort") || "8000";

    const board = document.querySelector('.results');
    const appendToBody = (html) => {
      const placeholder = document.createElement("div");
      placeholder.innerHTML = html;
      board.append(placeholder);
    }

    (async () => {
      // FAILING home page
      appendToBody(`
          <strong>TEST 1</strong> : Affichage du message posté par buddy
      `);
      const message = "Hello, i m buddy"
      appendToBody(`
        <strong>Nous envoyons le message : "${message}"</strong>
    `);
      // fetch(`http://${backendIp}:${backendPort}/api/jwt/login`, {
      await fetch(`http://${backendIp}:${backendPort}/api/buddy/send-msg`, {
        method: "POST",
        // headers: { // POUR les call qui sont DEJA authentifié
        //   ... : ... token(encoded) // Pas besoin pour le login...
        // }
        // Adding body or contents to send
        body: JSON.stringify({
            msg: message
        }),

        // Adding headers to the request
        headers: {
            "Content-type": "application/json; charset=UTF-8"
        }
      }).then(
        async resp => {
          const dataResp = await resp.json(); // this returns a promise
          // TODO
          return resp;
        }).then(repos => {
          console.log(repos)
        }).catch(ex => {
          console.error(ex);
        })
        appendToBody(`
        <strong>TEST 1</strong> : DONE
    `);
      appendToBody(`
          <strong>TEST 2</strong> : Affichage du message reçu par le serveur
      `);
      await fetch(`http://${backendIp}:${backendPort}/api/buddy/read-msgs`).then(
        async resp => {
          const dataResp = await resp.json(); // this returns a promise
          const json =JSON.stringify(dataResp.buddy_messages)
          const objet = JSON.parse(json);
          if (message == objet[objet.length-1]) {
            appendToBody(`
            <strong>Nous avons reçu le message : "${objet[objet.length-1]}"</strong>
              `);}
          return resp;
        }).then(repos => {
          console.log(repos)
        }).catch(ex => {
          console.error(ex);
        })
      appendToBody(`
        <strong>TEST 2 </strong> : DONE
    `);
    }
    )();
  </SCRIPT>

</html>